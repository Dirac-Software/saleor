services:
  # for the db, use the local dirac db from the dirac repo. We start a redis instance here. Mailpit is for testing emails in dev
  saleor:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    network_mode: host
    command: uvicorn saleor.asgi:application --host=0.0.0.0 --port=9000 --workers=2 --lifespan=off --ws=none --no-server-header --no-access-log --timeout-keep-alive=35 --timeout-graceful-shutdown=30 --limit-max-requests=10000
    env_file:
    - .env
    profiles:
      - dev
      - prod

  celery:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    network_mode: host
    command: sh -c "celery -A saleor --app=saleor.celeryconf:app worker --loglevel=info & celery -A saleor --app=saleor.celeryconf:app beat --loglevel=info"
    env_file:
      - .env
    depends_on:
      - cache
    profiles:
      - dev
      - prod

  cache:
    image: valkey/valkey:8.1-alpine
    restart: unless-stopped
    volumes:
      - saleor-cache:/data
    ports:
      - 6379:6379
    profiles:
      - dev
      - prod

  mailpit:
    image: axllent/mailpit
    ports:
      - 1025:1025 # SMTP Server
      - 8025:8025 # Mailpit UI
    restart: unless-stopped
    profiles:
      - dev

  media-server:
    build:
      context: .
      dockerfile: Dockerfile.media
    volumes:
      - ./media/products:/media/products:ro
      - ./media/thumbnails:/media/thumbnails:ro
      - ./media/user-avatars:/media/user-avatars:ro
      - ./media/category-backgrounds:/media/category-backgrounds:ro
      - ./media/collection-backgrounds:/media/collection-backgrounds:ro
      - ./media/app-brand-data:/media/app-brand-data:ro
      - ./media/app-installation-brand-data:/media/app-installation-brand-data:ro
      # Explicitly exclude private directories (served through Django with auth):
      # - payloads/ (webhook data, never accessed via HTTP)
      # - export_files/ (user exports, sensitive)
      # - invoices/ (order invoices, sensitive)
    ports:
      - 9010:9010
    restart: unless-stopped
    profiles:
      - dev
      - prod

volumes:
  saleor-cache:
    driver: local
